/*!
 * peeracle v0.0.1 (https://github.com/peeracle/peeracle)
 * Copyright 2015
 * Licensed under MIT
 */
"use strict";var Peeracle={};Peeracle.Media={},function(){var a=null,b=function(b){if(!a){var c;a=[];for(var d=0;256>d;d++){c=d;for(var e=0;8>e;e++)c=1&c?3988292384^c>>>1:c>>>1;a[d]=c}}for(var f=-1,g=0;g<b.length;g++)f=f>>>8^a[255&(f^b[g])];return(-1^f)>>>0},c={Crc32:b};Peeracle.Utils=c}(),function(){function a(a){var b=a,c=b?b.size:0,d=0,e=0,f=null,g=function(a,c,d){if(!b)return void d(null,0);var e=new FileReader;e.onload=function(a){var c=new Uint8Array(a.target.result);d(c,b.size)},e.readAsArrayBuffer(b.slice(a,c))},h=function(){return e},i=function(){return f},j=function(){return d+e},k=function(){return f?f.length-e:0},l=function(){return c},m=function(a){f&&a>=d&&a<d+f.length?e=a-d:(d=a,e=0,f=null)},n=function(a){m(j()+a)},o=function(a,b){if(a<k())return void b(null);var h=j(),i=h+a;i>c&&(i=c),g(h,i,function(a,g){return a?(d=h,e=j()-h,f=a,c=g,void b(a)):void b(null)})},p=function(a,b){return a<k()?void b(!1):void b(!0)};return{getIndex:h,getBuffer:i,getCurrentOffset:j,getBytesAvailable:k,getFileLength:l,read:n,seek:m,fetchBytes:o,ensureEnoughBytes:p}}Peeracle.File=a}(),function(){var a=function(){return[26,69,223,163]},b=function(a){var b=a,c=null,d=function(a,b,c){var d=0,e=1,f=128,g=1;if(d=a[b],!d)return null;for(;c>=e&&!(d&f);)e++,f>>=1;if(e>c)return null;for(d&=~f;g++<e;)d=d<<8|a[++b];return{length:e,value:d}},e=function(a,b){var c=d(b,a,4),e={};return e.id=c.value|1<<7*c.length,e.str=e.id.toString(16),e.headerSize=c.length,c=d(b,a+e.headerSize,8),e.dataSize=c.value,e.headerSize+=c.length,e},f=function(a){var c=b.getCurrentOffset();b.fetchBytes(12,function(d){if(!d)return void a(null);var f=b.getIndex(),g=e(f,d);b.read(g.headerSize),g.headerOffset=c,a(g)})},g=function(a,b,c){if(1>c||c>8)return null;for(var d=0,e=0;c>e;++e)d<<=8,d|=255&a[b+e];return d},h=function(a,c){b.seek(a.headerOffset),b.fetchBytes(a.headerSize+a.dataSize,function(d){return d?(b.read(a.headerSize+a.dataSize),void c(d)):void c(null)})},i=function(a){var b=0,c=e(b,a);return"1f43b675"!==c.str?null:(b=c.headerSize,c=e(b,a),"e7"!==c.str?null:(b+=c.headerSize,g(a,b,c.dataSize)))},j=function(a){f(function(d){return"1a45dfa3"!==d.str?void a(null):(b.read(d.dataSize),void f(function e(g){return"1f43b675"===g.str?(c=g,d.dataSize=g.headerOffset-d.headerSize,void h(d,function(b){a(b)})):("18538067"!==g.str&&b.read(g.dataSize),void f(e))}))})},k=function(a){return null==c?void a(null):void h(c,function(b){f(function(d){c=d&&"1f43b675"===d.str?d:null,a({timecode:i(b),bytes:b})})})};return{getInitSegment:j,getNextMediaSegment:k}},c=function(a){return new b(a)},d={WebM:{getFileHeader:a,create:c}};Peeracle.Media.WebM=d.WebM}(),function(){function a(){var a=function(a,c){a.fetchBytes(4,function(d){if(!d||4!==d.length)return void c(null);var e=null;a.seek(0);for(var f in b){var g=b[f].getFileHeader();if(g[0]===d[0]&&g[1]===d[1]&&g[2]===d[2]&&g[3]===d[3]){e=b[f].create(a);break}}return e?void c(e):void c(null)})},d=function(a){var b,c=40960,d=a/(c/20);for(b=16384;1048576>b&&d>b;b*=2);return b},e=function(b,e,f){a(b,function(a){if(!a)return void e(null);var g={hash:null,tracker:"ws://tracker.dotstar.fr:8080",init:null,chunksize:d(b.getFileLength()),clusters:[]};a.getInitSegment(function(b){g.init=b,g.hash=c.Crc32(b),a.getNextMediaSegment(function d(b){if(!b)return console.log(g.hash),void e(g);for(var h={timecode:b.timecode,size:b.bytes.length,chunks:[]},i=b.bytes.length,j=g.chunksize,k=0;i>k;k+=j){var l=b.bytes.subarray(k,k+j);h.chunks.push(c.Crc32(l)),f&&f(l.length),j>i-k&&(j=i-k)}g.clusters.push(h),a.getNextMediaSegment(d)})})})},f=function(){};return{create:e,load:f}}var b,c;"undefined"==typeof module?(b=Peeracle.Media,c=Peeracle.Utils):(b=require("./media"),c=require("./utils")),Peeracle.Metadata=a}(),function(){function a(a){var b,c=a,d=function(a){console.log("Peeracle.MediaChannel onerror",a)},e=function(a){console.log("Peeracle.MediaChannel onmessage",a.data)},f=function(){console.log("Peeracle.MediaChannel onopen")},g=function(){console.log("Peeracle.MediaChannel onclose")},h=function(a){b=a,b.onerror=d,b.onmessage=e,b.onopen=f,b.onclose=g},i=function(){b=c.createDataChannel("media"),h(b)},j=function(){return b.readyState};return{createDataChannel:i,setDataChannel:h,getReadyState:j}}Peeracle.MediaChannel=a}(),function(){function a(a){var b,c=a,d=function(a){console.log("Peeracle.SignalChannel onerror",a)},e=function(a){console.log("Peeracle.SignalChannel onmessage",a.data)},f=function(){console.log("Peeracle.SignalChannel onopen")},g=function(){console.log("Peeracle.SignalChannel onclose")},h=function(a){b=a,b.onerror=d,b.onmessage=e,b.onopen=f,b.onclose=g},i=function(){b=c.createDataChannel("signal"),h(b)},j=function(){return b.readyState};return{createDataChannel:i,setDataChannel:h,getReadyState:j}}Peeracle.SignalChannel=a}(),function(){function a(){var a,g,h,i=[],j=function(b){if(a&&b){var c=b.candidate;c&&(c=JSON.stringify(c)),i.forEach(function(a){a.onIceCandidate(c)})}},k=function(b){a&&b&&i.forEach(function(b){b.onConnectionStateChange(a.iceConnectionState)})},l=function(){},m=function(){console.log("_onReadyStateChange")},n=function(a){a&&a.channel&&("signal"===a.channel.label?g.setDataChannel(a.channel):"media"===a.channel.label&&h.setDataChannel(a.channel))},o=function(){var b={iceServers:[{url:"stun:stun.l.google.com:19302"}]};a=new c(b),a.onicecandidate=j,a.oniceconnectionstatechange=k,a.onicegatheringstatechange=l,a.ondatachannel=n,a.onreadystatechange=m,g=new f(a),h=new e(a)},p=function(a){var b=i.indexOf(a);~b||i.push(a)},q=function(a){var b=i.indexOf(a);~b&&i.splice(b,1)},r=function(b,c){var d=function(a){c(a)};o(),h.createDataChannel(),g.createDataChannel(),a.createOffer(function(c){a.setLocalDescription(c,function(){b(JSON.stringify(c))},d)},d)},s=function(b,c,e){var f=function(a){e(a)};o();var g=new d(JSON.parse(b));a.setRemoteDescription(g,function(){a.createAnswer(function(b){a.setLocalDescription(b,function(){c(JSON.stringify(b))},f)},f)},f)},t=function(b,c,e){var f=function(a){e(a)},g=new d(JSON.parse(b));a.setRemoteDescription(g,function(){c()},f)},u=function(c,d,e){a.addIceCandidate(new b(JSON.parse(c)),function(){d()},function(a){e(a)})},v=function(){a.close()};return{subscribe:p,unsubscribe:q,createOffer:r,createAnswer:s,setAnswer:t,addIceCandidate:u,close:v}}var b,c,d,e,f;if("undefined"==typeof module?(e=Peeracle.MediaChannel,f=Peeracle.SignalChannel):(e=require("./mediachannel"),f=require("./signalchannel")),"undefined"==typeof module)b=window.mozRTCIceCandidate||window.webkitRTCIceCandidate||window.RTCIceCandidate,c=window.mozRTCPeerConnection||window.webkitRTCPeerConnection||window.RTCPeerConnection,d=window.mozRTCSessionDescription||window.webkitRTCSessionDescription||window.RTCSessionDescription;else{var g=require("wrtc");c=g.RTCPeerConnection,d=g.RTCSessionDescription,b=g.RTCIceCandidate}Peeracle.Peer=a}(),function(){function a(a){var b,c=a,d={},e=[],f=function(){console.log("Peeracle.Tracker: onOpen"),b.send(""),e.forEach(function(a){a.onConnect()})},g=function(){console.log("Peeracle.Tracker: _onMessage")},h=function(){console.log("Peeracle.Tracker: _onError")},i=function(){console.log("Peeracle.Tracker: _onClose")},j=function(){b=new WebSocket(c),b.onopen=f,b.onmessage=g,b.onerror=h,b.onclose=i},k=function(a,b,c){d[a]in void 0||(d[a]=c)},l=function(a){d[a]in void 0&&delete d[a]},m=function(a){var b=e.indexOf(a);~b||e.push(a)},n=function(a){var b=e.indexOf(a);~b&&e.splice(b,1)};return{connect:j,announce:k,remove:l,subscribe:m,unsubscribe:n}}Peeracle.Tracker=a}();